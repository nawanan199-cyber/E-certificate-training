<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Certificate Checker</title>
  <script src="https://static.line-scdn.net/liff/2.22.0/sdk.js"></script>
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 0;
      padding: 20px;
      background-color: #f4f4f4;
      color: #333;
    }
    .container {
      background: #fff;
      padding: 20px;
      border-radius: 8px;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    }
    h2 {
      text-align: center;
      color: #00b900;
      margin-bottom: 20px;
    }
    input[type="text"] {
      width: calc(100% - 100px);
      padding: 10px;
      margin-right: 10px;
      border: 1px solid #ccc;
      border-radius: 4px;
      box-sizing: border-box;
    }
    button {
      padding: 10px 15px;
      background-color: #00b900;
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      box-sizing: border-box;
      width: 80px;
    }
    button:hover {
      background-color: #009900;
    }
    #result {
      margin-top: 20px;
      overflow-x: auto;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 15px;
      font-size: 0.9em;
    }
    th, td {
      border: 1px solid #ddd;
      padding: 8px;
      text-align: left;
    }
    th {
      background-color: #f2f2f2;
      color: #555;
      font-weight: bold;
    }
    /* CSS สำหรับแถบชื่อด้านบนตาราง */
    .summary-info {
      background-color: #e6ffe6; /* สีเขียวอ่อน */
      font-weight: bold;
      text-align: left;
      padding: 10px;
      margin-bottom: 15px; 
      border-radius: 4px;
      border: 1px solid #ccebcc; 
    }
    .not-found, .error-message {
      padding: 15px;
      background-color: #ffe6e6;
      color: #cc0000;
      border-radius: 4px;
      text-align: center;
      margin-top: 15px;
    }
    .valid {
      color: green;
      font-weight: bold;
    }
    .expired {
      color: red;
      font-weight: bold;
    }
  </style>
</head>
<body>
  <div class="container">
    <h2>Certificate Checker</h2>
    <div style="display: flex; margin-bottom: 15px;">
      <input type="text" id="name" placeholder="กรอกชื่อเต็ม (เช่น ใจดี ดีใจ)">
      <button onclick="search()">Search</button>
    </div>
    <div id="result"></div>
  </div>

<script>
  // ** ต้องแก้ไข: เปลี่ยน API_URL เป็น URL ที่คุณ Deploy จาก Google App Script **
  // ใช้ URL ที่ถูกต้องที่คุณได้รับจากการ Deploy ล่าสุด (URL ที่ไม่ขึ้น Failed to fetch)
  const API_URL = "https://script.google.com/macros/s/AKfycbwnGB7KcbuYPI93xMjxXp69tdskHlozb1vrRc4xPnZoRynl7y8tDR599bCPG9luMFc/exec"; // โปรดแทนที่ด้วย URL ล่าสุดที่คุณได้รับ
  const TODAY = new Date().toISOString().slice(0, 10); 

  // Headers ที่ต้องการแสดงผล (key ต้องตรงกับชื่อ Header ใน Google Sheet, ใช้ตัวพิมพ์เล็กและไม่มีสัญลักษณ์)
  const DISPLAY_HEADERS = [
    { key: 'licenseid', label: 'License ID' },    
    { key: 'affiliation', label: 'Affiliation' },
    { key: 'course', label: 'Course' },
    { key: 'duration', label: 'Hours' },        // คอลัมน์ Hours
    { key: 'issuedate', label: 'Issued' },        
    { key: 'expirydate', label: 'Expires' }       
  ];

  // ฟังก์ชันช่วยจัดรูปแบบวันที่ (แก้ไขให้แสดงเป็น DD/MM/YYYY ตามข้อมูลในชีท)
  function formatDate(dateString) {
    if (!dateString || dateString.toString().trim() === '' || dateString.toString().trim() === '-') {
      return ''; 
    }
    
    try {
      const date = new Date(dateString);

      if (isNaN(date)) {
        return dateString;
      }
      
      const day = String(date.getDate()).padStart(2, '0');
      const month = String(date.getMonth() + 1).padStart(2, '0'); 
      const year = date.getFullYear();

      // แสดงในรูปแบบ DD/MM/YYYY (ใช้ year.getFullYear() ซึ่งควรจะตรงกับข้อมูล)
      return `${day}/${month}/${year}`;

    } catch (error) {
      console.error("Date formatting error:", error);
      return dateString;
    }
  }


  async function search() {
    const nameInput = document.getElementById("name");
    const resultDiv = document.getElementById("result");
    const name = nameInput.value.trim();

    resultDiv.innerHTML = '<div class="searching">กำลังค้นหาข้อมูล...</div>';

    if (name === "") {
      resultDiv.innerHTML = '<div class="not-found">โปรดกรอกชื่อเต็มที่ต้องการค้นหา</div>';
      return;
    }

    try {
      const response = await fetch(`${API_URL}?name=${encodeURIComponent(name)}`);

      if (response.ok) {
        const data = await response.json();
        
        if (data.error) {
          resultDiv.innerHTML = `<div class="error-message">Error: ${data.error}</div>`;
        } else if (data.length > 0) {
          // ส่วนนี้คือการย้ายชื่อผู้ถูกค้นหาและบริษัทมาอยู่ด้านบนของตาราง
          const fullName = data[0]['name'] || 'N/A';
          const company = data[0]['company'] || 'N/A'; 
          let html = `<div class="summary-info">Name: ${fullName} | Company: ${company}</div>`; 

          html += '<table><thead><tr>';

          // Generate table headers
          DISPLAY_HEADERS.forEach(header => {
            html += `<th>${header.label}</th>`;
          });

          html += '</tr></thead><tbody>';

          // Generate table rows
          data.forEach(item => {
            html += '<tr>';
            DISPLAY_HEADERS.forEach(header => {
              let value = item[header.key] || ''; 
              let tdClass = '';

              // 1. จัดรูปแบบวันที่
              if (header.key === 'issuedate' || header.key === 'expirydate') { 
                  value = formatDate(value);
              }
              
              // 2. จัดการค่าว่าง
              if (value.toString().trim() === '' || value.toString().trim() === '-') {
                  html += `<td></td>`;
                  return;
              } 
              
              // 3. แสดงผล
              html += `<td class="${tdClass}">${value}</td>`;
            });
            html += '</tr>';
          });

          html += '</tbody></table>';
          resultDiv.innerHTML = html;

        } else {
          resultDiv.innerHTML = `<div class="not-found">ไม่พบประวัติการฝึกอบรมหรือใบอนุญาตสำหรับ "${name}"</div>`;
        }
      } else {
        resultDiv.innerHTML = `<div class="error-message">Error fetching data: ${response.status} ${response.statusText}</div>`;
      }
    } catch (error) {
      console.error("Fetch error:", error);
      resultDiv.innerHTML = `<div class="error-message">เกิดข้อผิดพลาดในการเชื่อมต่อ: ${error.message}</div>`;
    }
  }
</script>
</body>
</html>
           